<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Development environment &mdash; Minotour 1.0 documentation</title>
    
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="Minotour 1.0 documentation" href="index.html" />
    <link rel="next" title="Quickstart use cheatsheet" href="quickstart.html" />
    <link rel="prev" title="Threat agent analysis" href="dstl.html" />
   
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="development-environment">
<h1>Development environment<a class="headerlink" href="#development-environment" title="Permalink to this headline">¶</a></h1>
<p>To setup a local development environment, first clone or download and unzip the code from github found <a class="reference external" href="https://github.com/LooseLab/minotourapp.git">here</a>.</p>
<p>Checkout the development branch:</p>
<div class="highlight-python"><div class="highlight"><pre>git checkout develop
</pre></div>
</div>
<p>To run the python package mysqlclient, it is often necessary to have the following two dependencies installed, libmysqlclinet-dev and python3-dev. These can be installed with the following command:</p>
<div class="highlight-python"><div class="highlight"><pre>sudo apt-get install libmysqlclient-dev
sudo apt-get install python3-dev
</pre></div>
</div>
<p>Create a virtual environment for the project dependencies and install them:</p>
<div class="highlight-python"><div class="highlight"><pre>cd /path/to/minotourapp/code
python3 -m venv minotourenv
source minotourenv/bin/activate
pip install -r requirements.txt
</pre></div>
</div>
<p>Minotour contains three main modules:</p>
<ol class="arabic simple">
<li>The client, currently minFQ</li>
<li>web, the interface that most end users have access and provides access to active and archived runs</li>
<li>the rest api, that is a gateway connecting client and web modules to data and core Minotour functionalities.</li>
</ol>
<p>Minotour also makes use of a MySQL database, Celery (responsible for running server tasks), Redis (a database in memory similar to memcached, required by Celery as a message broker), Flower (optional - but a useful Celery task monitor tool).</p>
<ul>
<li><p class="first"><a class="reference external" href="https://redis.io/download">[Redis]</a> - Minotour uses <strong>Redis</strong> as a cache system for the web module and also for Celery. Follow the instructions and make sure that the <strong>redis-server</strong> executable is available in PATH environment variable.</p>
</li>
<li><p class="first"><a class="reference external" href="https://dev.mysql.com/downloads/">[MySQL Community edition]</a> - Minotour requires a MySQL server instance. It can run locally or on another server. Installing and configuring MySQL is not in the scope of this guide, but here is the official <a class="reference external" href="https://dev.mysql.com/doc/mysql-getting-started/en/">documentation</a> and another good tutorial can be found here [Link](<a class="reference external" href="https://www.digitalocean.com/community/tutorials/how-to-install-mysql-on-ubuntu-16-04">https://www.digitalocean.com/community/tutorials/how-to-install-mysql-on-ubuntu-16-04</a>). Once the server is up and running you can either choose to use the root user created during mySql initialisation in the below environmental variables, or create a user as follows in the mysql shell, logged in as the root user or an admin user:</p>
<div class="highlight-python"><div class="highlight"><pre>CREATE USER minotour;
CREATE TABLE minotourdb;
GRANT ALL PRIVILEGES ON minotourdb TO &#39;minotour&#39;@&#39;localhost&#39; IDENTIFIED BY &#39;&lt;password&gt;&#39;
</pre></div>
</div>
</li>
<li><p class="first"><a class="reference external" href="https://github.com/lh3/minimap2">[Minimap2]</a> - Minotour uses <strong>Minimap2</strong> to run fast alignment, and to do metagenomics target validation.</p>
</li>
<li><p class="first"><a class="reference external" href="https://www.python.org">[Python 3]</a> - Minotour uses <strong>Python &gt;=3.5</strong>, so make sure it is available on your system.</p>
</li>
<li><p class="first">You will need to have the virtual environment activated to run Minotour, Celery and Flower, as well as to install the new dependencies.</p>
</li>
<li><p class="first">Create Minotour data directory - currently, Minotour uses this folder to keep track of the genome references available:</p>
<div class="highlight-python"><div class="highlight"><pre>mkdir -p ~/data/minotour;
</pre></div>
</div>
</li>
</ul>
<div class="section" id="metagenomics-analyses">
<h2>Metagenomics analyses<a class="headerlink" href="#metagenomics-analyses" title="Permalink to this headline">¶</a></h2>
<p>minoTour uses <a class="reference external" href="https://ccb.jhu.edu/software/centrifuge/">Centrifuge</a> to run metagenomics analyses.
Before creating new metagenomics tasks, there are a few requirements that need to be completed.</p>
<ul>
<li><p class="first">Centrifuge index - Choose one of the centrifuge indexes (<a class="reference external" href="ftp://ftp.ccb.jhu.edu/pub/infphilo/centrifuge/data">ftp://ftp.ccb.jhu.edu/pub/infphilo/centrifuge/data</a>) and save in the local disk. We recommend the compressed index p_compressed</p>
</li>
<li><p class="first">Centrifuge application - <a class="reference external" href="https://github.com/infphilo/centrifuge/releases">Download</a> and compile the most recent version.</p>
</li>
<li><p class="first">Set the environment variables MT_CENTRIFUGE (the path to the executable) and MT_CENTRIFUGE_INDEX (the path to indexes without the suffix) as below:</p>
<div class="highlight-python"><div class="highlight"><pre>export MT_CENTRIFUGE=&quot;/home/user/centrifuge-1.0.4-beta/centrifuge&quot;

export MT_CENTRIFUGE_INDEX=&quot;/home/user/centrifuge_indexes/p_compressed&quot;
</pre></div>
</div>
</li>
</ul>
<p>The MT_CENTRIFUGE_INDEX above points to the following indexes:</p>
<p>p_compressed.1.cf</p>
<p>p_compressed.2.cf</p>
<p>p_compressed.3.cf</p>
<p>p_compressed.4.cf</p>
<ul class="simple">
<li>minoTour uses the ete3 package, that needs access to the internet to download the NCBI species database.</li>
</ul>
<p>To force the download (this step just need to be execured once), type the following instructions on the python interpreter.:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">ete3</span>

<span class="kn">from</span> <span class="nn">ete3</span> <span class="kn">import</span> <span class="n">NCBITaxa</span>

<span class="n">n</span> <span class="o">=</span> <span class="n">NCBITaxa</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="environmental-config-and-running">
<h2>Environmental config and running<a class="headerlink" href="#environmental-config-and-running" title="Permalink to this headline">¶</a></h2>
<ul>
<li><p class="first">Setup environment variables - many Minotour config parameters are stored in the environment, so that we do need to hardcode database users and password, or any other information that is environment dependent. You can create a bash script file, for example envs.sh, place it in the main application directory (The directory that contains manage.py) and copy the following into it, or include in the ~/.bash_profile or ~/.bash_rc (please check if this is the correct file in your environment).:</p>
<div class="highlight-python"><div class="highlight"><pre>#!/bin/bash
export MT_DB_ENGINE=&#39;django.db.backends.mysql&#39;
export MT_DB_HOST=&#39;localhost&#39;
export MT_DB_NAME=&#39;minotourdb&#39;
export MT_DB_PASS=&#39;&lt;minotourdb password&gt;&#39;
export MT_DB_PORT=&#39;3306&#39;
export MT_DB_USER=&#39;minotour&#39;
export MT_DJANGO_DEBUG=&#39;True&#39;
export MT_MAILGUN_ACCESS_KEY=&#39;&#39;
export MT_MAILGUN_SERVER_NAME=&#39;&#39;
export MT_MINIMAP2=&#39;/usr/bin/minimap2&#39;
export MT_REFERENCE_LOCATION=&#39;/home/rory/data/minotour&#39;
export MT_SECRET_KEY=&#39;&#39;
export MT_TWITCONSUMER_KEY=&#39;&#39;
export MT_TWITCONSUMER_SECRET=&#39;&#39;
export MT_CENTRIFUGE=&quot;&lt;/path/to/centrifuge/executable&gt;&quot;
export MT_CENTRIFUGE_INDEX=&quot;/path/to/centrifuge/indexes&quot;
export MT_TWITTOKEN=&#39;&#39;
export MT_TWITTOKEN_SECRET=&#39;&#39;
export MT_LOG_FOLDER=&#39;/path/to/where/you/want/logs&#39;
export MT_CELERY_BROKER_URL=&#39;redis://localhost:6379/0&#39;
export MT_CELERY_RESULT_BACKEND=&#39;redis://localhost:6379/0&#39;
</pre></div>
</div>
</li>
<li><p class="first">Now it is time to start the processes, we suggest opening a new terminal for each command. If you chose to create the environmental variable bash file, add the following to the beginning of the celery, flower and Minotour commands to set the environmental variables:</p>
<div class="highlight-python"><div class="highlight"><pre>. envs.sh &amp;&amp;
</pre></div>
</div>
</li>
<li><p class="first">MySQL - make sure it is running <strong>AND the database was created</strong> (check the docs mentioned above).</p>
</li>
<li><p class="first">Redis:</p>
<div class="highlight-python"><div class="highlight"><pre>redis-server &amp;
</pre></div>
</div>
</li>
<li><p class="first">Create tables and administrator account:</p>
<div class="highlight-python"><div class="highlight"><pre>cd /path/to/minotour/code;
source ~/minotourenv/bin/activate;
python3 manage.py makemigrations;
python3 manage.py migrate;
python3 manage.py loaddata fixtures/auxiliary_data.json
python3 manage.py createsuperuser
</pre></div>
</div>
</li>
<li><p class="first">Start Celery:</p>
<div class="highlight-python"><div class="highlight"><pre>cd /path/to/minotour/code/ &amp;&amp; source minotourenv/bin/activate &amp;&amp; celery -A minotourapp worker -l info -B
</pre></div>
</div>
</li>
<li><p class="first">Start Flower:</p>
<div class="highlight-python"><div class="highlight"><pre>cd /path/to/minotour/code/ &amp;&amp; source minotourenv/bin/activate &amp;&amp; &amp;&amp; flower -A minotourapp --port=5555
</pre></div>
</div>
</li>
<li><p class="first">Start Minotour:</p>
<div class="highlight-python"><div class="highlight"><pre>cd /path/to/minotour/code
source minotourenv/bin/activate
python manage.py runserver 8100
</pre></div>
</div>
</li>
<li><p class="first">Time to test - if everything worked well, you should be able to access the web interface on <a class="reference external" href="http://localhost:8100">http://localhost:8100</a>.</p>
</li>
</ul>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">Minotour</a></h1>





<p>
<iframe src="https://ghbtns.com/github-btn.html?user=&repo=&type=watch&count=true&size=large"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>




<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="docker.html">Using docker</a></li>
<li class="toctree-l1"><a class="reference internal" href="minfq.html">Minotour client</a></li>
<li class="toctree-l1"><a class="reference internal" href="dstl.html">Threat agent analysis</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="">Development environment</a><ul class="simple">
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">Quickstart use cheatsheet</a></li>
<li class="toctree-l1"><a class="reference internal" href="faqs.html">FAQ</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="dstl.html" title="previous chapter">Threat agent analysis</a></li>
      <li>Next: <a href="quickstart.html" title="next chapter">Quickstart use cheatsheet</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, Matt Loose Roberto Santos Rory Munro.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.3.6</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.7</a>
      
      |
      <a href="_sources/development.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>