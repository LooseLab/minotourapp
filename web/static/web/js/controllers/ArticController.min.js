var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.createTemplateTagFirstArg=function(a){return a.raw=a};$jscomp.createTemplateTagFirstArgWithRaw=function(a,b){a.raw=b;return a};$jscomp.arrayIteratorImpl=function(a){var b=0;return function(){return b<a.length?{done:!1,value:a[b++]}:{done:!0}}};$jscomp.arrayIterator=function(a){return{next:$jscomp.arrayIteratorImpl(a)}};$jscomp.makeIterator=function(a){var b="undefined"!=typeof Symbol&&Symbol.iterator&&a[Symbol.iterator];return b?b.call(a):$jscomp.arrayIterator(a)};
$jscomp.arrayFromIterator=function(a){for(var b,c=[];!(b=a.next()).done;)c.push(b.value);return c};$jscomp.arrayFromIterable=function(a){return a instanceof Array?a:$jscomp.arrayFromIterator($jscomp.makeIterator(a))};
var ArticController=function(a){this._articCoverageScatterMaster="hello";this._articCoverageScatterDetail="world";this._flowcellId=a;this._first=!0;this._barcodeChosen=null;this._logged=$("#log-coverage")[0].checked?1:0;this._axiosInstance=axios.create({headers:{"X-CSRFToken":getCookie("csrftoken")}});this._perBarcodeCoverageChart=this._perBarcodeAverageReadLengthChart=null;this._coverageSummaryTable=$("#artic-coverage-summary-table");this._articProportionPieChart=null;this._interval=setInterval(this._drawArticCharts,
1E4,this);$(window).on("unload",function(){console.log("clearing Artic interval");clearInterval(this._interval)});this._90Input=$("#90-input");this._95Input=$("#95-input");this._99Input=$("#99-input");this._fireButton=$("#update-fire-params");this._fireInputs=[this._90Input,this._95Input,this._99Input];this._showFiringConditions(a);this._addListenerToFireInputs();this._renderAllResultsModal(a)};
ArticController.prototype._submitFireChoices=function(){var a={};this._fireInputs.forEach(function(b){a[b.attr("id")]=b.val()});this._axiosInstance.post("/api/v1/artic/"+this._flowcellId+"/firing-conditions",a).then(function(b){alert(b.data)})["catch"](function(b){console.error(b)})};ArticController.prototype._addListenerToFireInputs=function(){var a=this;this._fireInputs.forEach(function(b){b.on("change",function(c){a._fireButton.attr("disabled",!1)})});this._fireButton.on("click",function(){a._submitFireChoices()})};
ArticController.prototype._showFiringConditions=function(a){var b=this;this._axiosInstance.get("/api/v1/artic/"+a+"/firing-conditions").then(function(c){c=c.data;b._90Input.val(c.ninety_percent_bases_at);b._95Input.val(c.ninety_five_percent_bases_at);b._99Input.val(c.ninety_nine_percent_bases_at)})["catch"](function(c){console.error(c.response)})};ArticController.prototype.updateTab=function(){this._drawArticCharts(this)};
ArticController.prototype._updateExistingChart=function(a,b,c){checkHighChartsDataIsIdentical(b,a.series[c].options.data)||a.series[c].setData(b)};
ArticController.prototype._createCoverageMaster=function(a,b){var c=this,d=this;this._axiosInstance.get("/api/v1/artic/fetch-amplicon-bands").then(function(e){var f=e.data.colours,g=[],h=[];e.data.amplicon_band_coords.forEach(function(m,k){var l={from:m[0],to:m[1],color:f[m[2]]};g.push(l);h.push(Object.assign({},l,{label:{text:"# "+(k+1),style:{color:"grey"},rotation:270}}))});c._articCoverageScatterMaster=Highcharts.chart("coverageArticMaster",{chart:{zoomType:"x",height:"150px",marginLeft:50,marginRight:20,
events:{selection:d._afterSelection.bind(c)}},xAxis:{min:0,max:a.coverage.xmax,gridLineWidth:1,zoomEnabled:!1,maxZoom:1E4,title:{text:"Base Number"},plotBands:[].concat($jscomp.arrayFromIterable(g),[{id:"mask-before",from:a.coverage.data[0][0],to:a.coverage.data[a.coverage.data.length-1][0],color:"rgba(0, 0, 0, 0.2)"}])},yAxis:{min:.1,max:a.coverage.ymax,title:{text:"Coverage"}},legend:{enabled:!1},title:{text:null},plotOptions:{series:{fillColor:{linearGradient:[0,0,0,70],stops:[[0,Highcharts.getOptions().colors[0]],
[1,"rgba(255, 255, 255, 0)"]]},lineWidth:1,marker:{enabled:!1},shadow:!1,states:{hover:{lineWidth:1}},enableMouseTracking:!1}},series:[{type:"area",color:"blue",data:[],marker:{fillcolor:"red",radius:1},tooltip:{followPointer:!1,pointFormat:"[{point.x:.1f}, {point.y:.1f}]",valueDecimals:8}}]},function(){d._articCoverageScatterDetail=d._createDetailChart("coverageArticDetail",a.coverage.ymax,"Coverage","line",!1,!1,h)})})["catch"](function(e){console.error(e)})};
ArticController.prototype._createDetailChart=function(a,b,c,d,e,f,g){d=void 0===d?"scatter":d;e=void 0===e?!1:e;f=void 0===f?!1:f;g=void 0===g?[]:g;return Highcharts.chart(a,{chart:{zoomType:"x",height:"300px",reflow:!0,events:{selection:this._afterSelection.bind(this)}},xAxis:{type:d,gridLineWidth:1,title:{text:"Base number"},plotBands:g},yAxis:{softMin:0,max:b,title:{text:null},startOnTick:!1,endOnTick:!0},title:{text:c},legend:{enabled:f},tooltip:{formatter:function(){return"The value for base <b>"+
this.x+"</b> is <b>"+this.y+"</b>"}},exporting:{enabled:!0},series:[{type:d,color:"blue",step:e,data:[],marker:{fillcolor:"red",radius:1},tooltip:{followPointer:!1,pointFormat:"[{point.x:.1f}, {point.y:.1f}]",valueDecimals:8}}]})};
ArticController.prototype._afterSelection=function(a){var b=this,c=this._flowcellId,d=[this._articCoverageScatterDetail],e=Math.trunc(a.xAxis[0].min),f=Math.trunc(a.xAxis[0].max),g=this._logged?1:0;a.preventDefault();b._articCoverageScatterMaster.xAxis[0].removePlotBand("mask-before");b._articCoverageScatterMaster.xAxis[0].addPlotBand({id:"mask-before",from:e,to:f,color:"rgba(0, 0, 0, 0.2)"});d.forEach(function(h){h.showLoading("Fetching data from the server")});this._axiosInstance.get("/api/v1/artic/visualisation/detail",
{params:{min:e,max:f,barcodeChosen:this._barcodeChosen,flowcellId:c,logCoverage:g}}).then(function(h){if(200===h.status)b._updateAxesAndData(b._articCoverageScatterDetail,e,f,h.data.coverage,!0);else if(404===h.status)console.error("Artic detail chart data not found.");else throw"Request error";})["catch"](function(h){console.error(h)})};
ArticController.prototype._updateAxesAndData=function(a,b,c,d,e){a.xAxis[0].setExtremes(b,c);e&&(this._logged?(a.yAxis[0].setExtremes(.1,d.ymax),a.update({yAxis:{type:"logarithmic"}})):(a.update({yAxis:{type:"linear"}}),a.yAxis[0].setExtremes(0,d.ymax)));a.series[0].setData(d.data);a.hideLoading()};
ArticController.prototype._createOrUpdateSelectionBox=function(a){var b,c,d,e=this;var f=[];var g=$("#select-artic-barcode");var h=0===g.children("option").length;e._axiosInstance.get("/api/v1/artic/visualisation/barcodes",{params:{flowcellId:a}}).then(function(m){200!==m.status&&console.error("Error");b=m.data;h?b.unshift("Choose Barcode"):(c=[].concat($jscomp.arrayFromIterable($("#select-artic-barcode")[0].children)),c.forEach(function(k){b.includes(k.textContent)&&(d=b.indexOf(k.textContent),b.splice(d,
1))}));b.forEach(function(k){"Choose Barcode"===k?f.push('<option class="sel__box__options" id="place-holder" value="'+k+'">'+k+"</option>"):f.push('<option class="sel__box__options" value="'+k+'">'+k+"</option>")});f.length&&g.html(f.join(""));h&&g.change(function(){var k=$(this).val();e._barcodeChosen=k;$("#place-holder").remove();$("#log-coverage").attr("disabled",!1);e._drawSelectedBarcode(a,k)})})["catch"](function(m){console.error(m)})};
ArticController.prototype._drawSelectedBarcode=function(a,b){var c=this,d=this,e,f=this._logged?1:0,g=f?"Log 10 coverage":"Coverage";$("coverage-card-title").html(b+" Coverage Plots");d._articCoverageScatterMaster.showLoading("Fetching data from server.");!0===!this._articCoverageScatterMaster.xAxis[0].zoomEnabled&&(this._articCoverageScatterMaster.xAxis[0].zoomEnabled=!0);this._axiosInstance.get("/api/v1/artic/visualisation/master",{params:{flowcellId:a,barcodeChosen:b,logCoverage:f}}).then(function(l){c._logged?
(e="logarithmic",d._updateExistingChart(d._articCoverageScatterMaster,l.data.coverage.data,0),d._articCoverageScatterMaster.yAxis[0].setExtremes(.1,l.data.coverage.ymax),d._articCoverageScatterMaster.update({yAxis:{min:.1,max:l.data.coverage.ymax}}),d._articCoverageScatterMaster.update({yAxis:{type:e}})):(e="linear",d._articCoverageScatterMaster.update({yAxis:{type:e}}),d._articCoverageScatterMaster.yAxis[0].setExtremes(0,l.data.coverage.ymax,!0),d._updateExistingChart(d._articCoverageScatterMaster,
l.data.coverage.data,0));d._articCoverageScatterMaster.yAxis[0].setTitle({text:g});d._articCoverageScatterMaster.hideLoading()})["catch"](function(l){console.error(l)});var h=$("#coverageArticDetail").highcharts();var m=h.xAxis[0].min;var k=h.xAxis[0].max;void 0!==m&&(d._articCoverageScatterDetail.showLoading("Fetching data from the server"),this._axiosInstance.get("/api/v1/artic/visualisation/detail",{params:{min:m,max:k,barcodeChosen:d._barcodeChosen,flowcellId:a,logCoverage:f}}).then(function(l){d._articCoverageScatterDetail.yAxis[0].setTitle({text:g});
d._updateAxesAndData(d._articCoverageScatterDetail,m,k,l.data.coverage,!0)})["catch"](function(l){console.error(l)}));this._setBarcodeMetaDataHTMLTable(a,b);this._renderPngs(a,b,!0)};
ArticController.prototype._drawArticCharts=function(a){var b=a._flowcellId;if(!Highcharts.Series.prototype.renderCanvas)throw"Module not loaded";if("artic"===getSelectedTab()){console.time("scatter");if(!0===a._first){var c={coverage:{ymax:1,data:[0,1]}};a._createCoverageMaster(c,b);a._createOrUpdateSelectionBox(b);a._addListenerToLogSlider(b);a._drawColumnCharts();a._createArticPieChart(b);a._drawOrUpdateSummaryTable(a._coverageSummaryTable,b);a._first=!1}else a._updateColumnCharts(b),a._updateArticPieChart(b),
a._drawOrUpdateSummaryTable(a._coverageSummaryTable,b),a._createOrUpdateSelectionBox(b),this._barcodeChosen&&(a._setBarcodeMetaDataHTMLTable(b,a._barcodeChosen),a._drawSelectedBarcode(b,a._barcodeChosen),a._renderPngs(b,a._barcodeChosen,!0));console.timeEnd("scatter")}};
ArticController.prototype._drawColumnCharts=function(){var a=this._flowcellId;this._perBarcodeCoverageChart||(this._perBarcodeCoverageChart=makeColumnChart("artic-per-barcode-coverage","PASS READ COUNTS PER BARCODE","READ COUNT"));this._perBarcodeAverageReadLengthChart||(this._perBarcodeAverageReadLengthChart=makeColumnChart("artic-per-barcode-average-length","MEAN PASS READ LENGTH PER BARCODE","READ LENGTH (BASES)"));this._updateColumnCharts(a)};
ArticController.prototype._updateColumnCharts=function(a){var b=this;this._axiosInstance.get("/api/v1/artic/visualisation/column-charts",{params:{flowcellId:a}}).then(function(c){c=c.data;var d=b._perBarcodeCoverageChart.series,e=b._perBarcodeAverageReadLengthChart.series,f={xAxis:{categories:c.barcodes}},g=d.findIndex(function(h){return"Read Counts"===h.name});b._perBarcodeCoverageChart.update(f);b._perBarcodeAverageReadLengthChart.update(f);b._perBarcodeCoverageChart.showLoading('<div class="spinner-border text-success" role="status">\n                        <span class = "sr-only"> Loading...</span></div>');
b._perBarcodeAverageReadLengthChart.showLoading('<div class="spinner-border text-success" role="status">\n                        <span class = "sr-only"> Loading...</span></div>');0<=g?checkHighChartsDataIsIdentical(c.read_counts,d[g].options.data)||(d[g].setData(c.read_counts),e[g].setData(c.average_read_length)):(b._perBarcodeCoverageChart.addSeries({name:"Read Counts",data:c.read_counts}),b._perBarcodeAverageReadLengthChart.addSeries({name:"Average read length",data:c.average_read_length}));b._perBarcodeCoverageChart.hideLoading();
b._perBarcodeAverageReadLengthChart.hideLoading()})["catch"](function(c){console.error(c)})};
ArticController.prototype._drawOrUpdateSummaryTable=function(a,b){var c=this;$.fn.DataTable.isDataTable(a)?a.DataTable().ajax.reload(null,!1):a.DataTable({createdRow:function(d,e,f){e.has_finished?($(d).addClass(["finished-pipeline","artic-tr-row"]),$("#download-results-all").prop("disabled",!1)):$(d).addClass("artic-tr-row");$(d).on("click",function(){c._barcodeChosen=e.barcode_name;$("#select-artic-barcode").val(e.barcode_name);$("#place-holder").remove();$("#log-coverage").attr("disabled",!1);
c._drawSelectedBarcode(c._flowcellId,e.barcode_name)})},ajax:{url:"/api/v1/artic/visualisation/summary-table-data",data:{flowcellId:b},async:!0,error:function(d,e,f){console.error(d);console.error(f)}},columnDefs:[{targets:0,data:"barcode_name"},{targets:1,data:"chromosome__line_name"},{targets:2,data:"reference_line_length"},{targets:3,data:"read_count"},{targets:4,data:"total_yield"},{targets:5,data:"average_read_length"},{targets:6,data:"coverage"},{targets:7,data:"99%_value"},{targets:8,data:"95%_value"},
{targets:9,data:"90%_value"},{targets:10,data:"has_sufficient_coverage"}]})};ArticController.prototype._setBarcodeMetaDataHTMLTable=function(a,b){this._axiosInstance.get("/api/v1/artic/barcode-metadata",{params:{flowcellId:a,selectedBarcode:b}}).then(function(c){$("#articMetaInfo").html(c.data)})["catch"](function(c){console.error(c)})};
ArticController.prototype.manuallyTriggerPipeline=function(a,b,c,d){d.preventDefault();this._axiosInstance.post("/api/v1/artic/manual-trigger/",{flowcellId:a,barcodePk:b,jobTypeId:17,jobPk:c}).then(function(e){e=e.data;$("#manual-trigger").remove();$("#artic-message").css("display","block").html(e)})["catch"](function(e){console.error(e)})};
ArticController.prototype.buildResults=function(a,b,c,d){var e={string:$(".results-builder-form").serialize()};c.preventDefault();e.params={flowcellId:a,selectedBarcode:b,all:d};this._axiosInstance.get("/api/v1/artic/build-results",{params:e,Accept:"application/gzip","Content-Type":"application/gzip",responseType:"blob"}).then(function(f){var g=window.URL.createObjectURL(new Blob([f.data])),h=document.createElement("a");h.href=g;h.setAttribute("download",f.headers["x-file-name"]);document.body.appendChild(h);
h.click()})["catch"](function(f){alert(f);console.error(f)})};ArticController.prototype._renderPngs=function(a,b,c){$(".rendered").length&&!c||$("#marked-rerun").length||this._axiosInstance.get("/api/v1/artic/fetch-png-html",{params:{flowcellId:a,selectedBarcode:b}}).then(function(d){$("#artic-pngs").html(d.data)})};ArticController.prototype._addListenerToLogSlider=function(a){var b=this;$("#log-coverage").on("change",function(){b._logged=!b._logged;b._drawSelectedBarcode(a,b._barcodeChosen)})};
ArticController.prototype._addListenerToDownloadResults=function(a){var b=this;$("#submit-download").on("click",function(c){var d=$(c.currentTarget).data();b.buildResults(b._flowcellId,d.barcode,c,!!d.all)})};ArticController.prototype._getAllOrNot=function(){$("#results-builder").on("show.bs.modal",function(a){var b=$(a.relatedTarget);a=!!b.data("all");b=b.data("barcode");$("#submit-download").data({all:a,barcode:b})})};
ArticController.prototype._renderAllResultsModal=function(a){var b=this;this._axiosInstance.get("/api/v1/artic/"+a+"/results-modal").then(function(c){c=c.data;$("#modal-container").html(c);b._getAllOrNot();b._addListenerToDownloadResults(a)})["catch"](function(c){console.error(c)})};
ArticController.prototype.reRunArticCommand=function(a,b,c){c.preventDefault();this._axiosInstance.patch("/api/v1/artic/rerun-command/",{flowcellId:a,selectedBarcodePk:b}).then(function(d){$("#artic-message").html("Successfully listed artic task for rerunning.");$("#rerun-btn").remove()})["catch"](function(d){$("#artic-message").html(d.message);setTimeout(5E3,function(){$("#artic-message").empty()});console.error(d)})};
ArticController.prototype._createArticPieChart=function(a){this._articProportionPieChart||(this._articProportionPieChart=makePieChart("artic-per-barcode-classification","PROPORTION OF READS BARCODE CLASSIFIED"));this._updateArticPieChart(a)};
ArticController.prototype._updateArticPieChart=function(a){var b=this;this._axiosInstance.get("/api/v1/artic/pie-chart-data",{params:{flowcellId:a}}).then(function(c){var d=c.data;c=b._articProportionPieChart.series.filter(function(e){return e.name===d[0].name});c.length?checkHighChartsDataIsIdentical(c[0].options.data.map(function(e){return e.y}),d[0].data.map(function(e){return e.y}))||c[0].setData(d[0].data):b._articProportionPieChart.addSeries(d[0])})};