var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.createTemplateTagFirstArg=function(e){return e.raw=e};$jscomp.createTemplateTagFirstArgWithRaw=function(e,a){e.raw=a;return e};
var MetagenomicsController=function(e){this._flowcellId=e;this._axiosInstance=axios.create({headers:{"X-CSRFToken":getCookie("csrftoken")}});setSelectedBarcode("All reads","Metagenomics");this._selectedBarcode=getSelectedBarcode("Metagenomics");this._addExpandButtonListener();this.colour=d3.scaleOrdinal(d3.schemeCategory10);this._first=!0;this._range=$(".input-range");this._value=$(".taxa-level");this._taxas="species genus family order class phylum superkingdom".split(" ");this._displayTaxas="Species Genus Family Order Class Phylum Kingdom".split(" ");
this._donutData=[];this._barcodesSet=new Set;this._barcodeDivElement=$("#nav-tabs-meta-barcodes");this._addListenerToRangeSlider()};MetagenomicsController.prototype.updateTab=function(){this._drawSuperSimpleTable(this._flowcellId);this._getTotalReadsTable(this._flowcellId);this._drawDonutAndTable(this._flowcellId);this._metaDataTable(this._flowcellId);this._addBarcodeTabs(this._flowcellId);this._updateMappingTable(this._flowcellId);this._drawSimpleTable(this._flowcellId);this._initialiseSankey(this._flowcellId)};
MetagenomicsController.prototype._addExpandButtonListener=function(){$("#expand-button").click(function(){$(this).text(function(e,a){return"Expanddata"===a.replace(/(\r\n|\n|\r|\s)/gm,"")?"Hide data":"Expand data"})})};
MetagenomicsController.prototype._revealMetagenomicsPage=function(){d3.select("#loading-sign").transition().duration(1E3).style("opacity",0);setTimeout(function(){$("body").addClass("loaded");d3.select("#loading-sign").style("display","none");d3.select(".vis-container").style("display","contents")},1500)};
MetagenomicsController.prototype._getTotalReadsTable=function(e){var a=$(".tableLand");$.fn.DataTable.isDataTable(a)?a.DataTable().ajax.reload(null,!1):a.DataTable({processing:!0,serverSide:!0,ajax:{url:"/api/v1/metagenomics/"+e+"/table/",async:!0,error:function(d,g,h){console.error(d);console.error(h);console.error(g)}},columns:[{data:"barcode_name"},{data:"superkingdom"},{data:"phylum"},{data:"classy"},{data:"order"},{data:"family"},{data:"genus"},{data:"species"},{data:"num_matches"},{data:"proportion_of_classified"}]})};
MetagenomicsController.prototype.move=function(e,a){console.log(e);console.log(a);d3.select("."+e.sourceEvent.srcElement.firstChild.classList[0]).attr("transform",e.transform)};
MetagenomicsController.prototype._drawPie=function(e,a,d,g){var h=d3.scaleOrdinal(d3.schemeCategory10);e=g.select(".slices").selectAll("path.slice").data(a(e));e.attr("class","slice").style("fill",function(c,l){return h(l)}).attr("stroke","black").attr("stroke-width",.2).attr("d",d).select("title").text(function(c){return c.data.label+"\n"+c.value+" reads"});e.enter().insert("path").attr("class","slice").style("fill",function(c,l){return h(c.data.label)}).attr("stroke","black").attr("stroke-width",
.2).attr("d",d).append("title").text(function(c){return c.data.label+"\n"+c.value+" reads"});e.exit().remove()};
MetagenomicsController.prototype._drawDonutAndTable=function(e){var a=this,d=getSelectedBarcode("Metagenomics"),g=d3.select(".rank-table-container"),h=.25*$(window).width()-76,c=.27*$(window).height(),l=Math.min(h,c)/2,f=d3.zoom().scaleExtent([1,10]).translateExtent([[0,0],[h,c]]).on("zoom",this.move),p=$(".taxa-level"),m=d3.pie().padAngle(.01).sort(null).value(function(b){return b.value}),n=d3.arc().innerRadius(.8*l).outerRadius(.5*l).padAngle(.02);this._pie=m;this._arc=n;if(0!==$(".donut-svg").length){var q=
d3.select(".donut-svg");d3.select(".slices").attr("transform","translate("+h/2+","+c/2+")")}else this._svg=q=d3.select(".donutContainer").append("svg").attr("class","donut-svg").attr("width",h).attr("height",c).attr("margin","auto").attr("display","block").call(f),l=q.append("g").attr("class","badCopNoDonut"),l.append("g").attr("class","slices").attr("transform","translate("+h/2+","+c/2+")"),p.html(this._displayTaxas[0]);this._axiosInstance.get("/api/v1/metagenomics/donut",{params:{flowcellId:e,visType:"donut",
barcode:d}}).then(function(b){if(void 0===b.data||void 0===b.data.species)q.select(".badCopNoDonut").selectAll("*").remove(),q.append("text").text("No data to display").attr("text-anchor","middle").attr("x","50%").attr("y","50%"),g.selectAll("*").remove(),g.append("div").style("height",c+"px").style("transform","translateY( 50%)").attr("class","col-md-12").append("text").text("No data to display").classed("no-data",!0);else{g.select("div").remove();b=a._donutData=b.data;var k=a._taxas[a._range.val()];
b=b[k];a._drawPie(b,m,n,q);b=a._formatTableData(b,a.colour);a._drawTables("rank-table-container",b)}})["catch"](function(b){console.error(b)})};MetagenomicsController.prototype._addListenerToRangeSlider=function(){var e=this,a=this;this._range.on("input",function(){var d=a._range.val(),g=e._donutData[a._taxas[d]];a._value.html(a._displayTaxas[d]);a._drawPie(g,a._pie,a._arc,a._svg);d=a._formatTableData(g,a.colour);e._drawTables("rank-table-container",d)})};
MetagenomicsController.prototype._formatTableData=function(e,a){var d=[];e.forEach(function(g,h){d.push({Species:g.label,"# Matches":g.value,Rank:h+1,Key:a(h)})});return d};
MetagenomicsController.prototype._drawTables=function(e,a){var d=["Species","# Matches","Rank","Key"];var g=this._first?d3.select("."+e).append("table").attr("class","table table-hover taxons"):d3.select("."+e).select("table");var h=this._first?g.append("tbody").attr("class",e+"Body"):g.select("tbody");this._first&&g.append("thead").append("tr").selectAll("th").data(d).enter().append("th").text(function(c){return c});g=h.selectAll("tr");g.data(a).exit().remove();g.data(a).enter().append("tr");g.data(a).exit().remove();
g=h.selectAll("tr");h=g.selectAll("td");h.data(function(c){return d.map(function(l){return{column:l,value:c[l]}})}).enter().append("td");h=g.selectAll("td");h.data(function(c){return d.map(function(l){return{column:l,value:c[l]}})}).attr("class",function(c,l){return d[l]}).style("background-color",function(c,l){if("string"===typeof c.value)return c.value.includes("#")?c.value:"white"}).html(function(c){if("string"===typeof c.value){if(!c.value.includes("#"))return c.value}else return c.value});this._first=
!1};
MetagenomicsController.prototype._metaDataTable=function(e){this._axiosInstance.get("/api/v1/metagenomics/metagenomics-metadata/",{params:{flowcellId:e}}).then(function(a){var d=a.data.result;a=a.data.validation?".metadata-table":".metadata-table-alt";d3.select(a).classed("has-table")?a=d3.select(a).select("table").select("tr"):(a=d3.select(a).classed("has-table",!0).append("table").attr("class","table table-striped").attr("table-layout","fixed"),a=a.append("thead"),a=a.append("tr"));0!==d[1].value&&(a.selectAll("th").data(d).enter().append("th"),
a.selectAll("th").data(d).html(function(g){return g.key+g.value}))})["catch"](function(a){console.error(a)})};
MetagenomicsController.prototype._addBarcodeTabs=function(e){var a=this;this._axiosInstance.get("/api/v1/metagenomics/"+e+"/metagenomic-barcodes").then(function(d){var g=d.data.data.sort(),h=d.data.tabs,c=getSelectedBarcode("Metagenomics"),l=[],f={0:"green-alert-tab",1:"green-alert-tab",2:"orange-alert-tab",3:"red-alert-tab"};g.forEach(function(p){a._barcodesSet.add(p)});a._barcodesSet.forEach(function(p){var m="",n="";h.length&&(m=f[h[p]]);p===c&&(n="active");l.push('<li class="barcode-meta-tab nav-item '+
m+'"><a class="nav-link '+n+'" id="meta-barcode-link">'+p+"</a></li>")});a._barcodeDivElement.html(l);$("#meta-barcode-link").on("click",function(){setSelectedBarcode(event.srcElement.innerText,"Metagenomics");a.updateTab()})})["catch"](function(d){console.error(d)})};MetagenomicsController.prototype._compare=function(e,a){return e.Species<a.Species?-1:e.Species>a.Species?1:0};
MetagenomicsController.prototype._compare2=function(e,a){return e["Validation species"]<a["Validation species"]?-1:e["Validation species"]>a["Validation species"]?1:0};
MetagenomicsController.prototype._updateMappingTable=function(e){var a=this,d,g,h,c,l,f=0,p="Alert level;Species;Num. matches;Prop. classified (%);Num. mapped;Mapped prop. matches (%);Target reads;Target prop. mapped (%)".split(";"),m=getSelectedBarcode("Metagenomics");this._axiosInstance.get("/api/v1/metagenomics/mapped-targets",{params:{flowcellId:e,barcode:m}}).then(function(n){var q=n.data.table,b=d3.select(".alert-table").classed("has-tabley?");204===n.status?(d3.select(".alert-table-complex").remove(),
d3.select(".button-row").remove(),d3.select("#demo").classed("in",!0)):void 0===q?(n=d3.select(".alert-table"),n.selectAll("*").remove(),n.append("text").text("No data to display"),n.classed("no-data",!0)):(d3.select(".alert-table").classed("no-data",!1).select("text").remove(),q.sort(a._compare),d=b?d3.select(".alert-table").select("table"):d3.select(".alert-table").classed("has-tabley?",!0).style("width","100%").append("table").attr("class","table map-alert"),g=b?d.select("thead"):d.append("thead").append("tr"),
h=b?d.select("tbody"):d.append("tbody").attr("class","alert-tbody"),g.selectAll("th").data(p).enter().append("th").text(function(k){return k}),c=h.selectAll("tr"),c.data(q).enter().append("tr").attr("id",function(k){return k.Species.replace(/ /g,"_")}),c.data(q).exit().remove(),c=h.selectAll("tr"),l=c.selectAll("td"),l.data(function(k){return p.map(function(t){return{column:t,value:k[t]}})}).enter().append("td"),l=c.selectAll("td"),l.data(function(k){return p.map(function(t){return{column:t,value:k[t]}})}).attr("id",
function(k,t){"Alert level"===k.column&&(f+=1);return p[t].replace(" ","_")+"_"+f.toString()}).style("background-color",function(k,t){var r=d3.select("#"+d3.select(this).node().parentNode.children[0].id);"Num. mapped"===k.column&&0<k.value?(r.classed("green-alert",!1),r.classed("yellow-alert",!1),r.classed("red-alert",!0)):"Target reads"===k.column&&0<k.value?(r.classed("green-alert",!1),r.classed("orange-alert",!1),r.classed("yellow-alert",!1),r.classed("red-alert",!0)):"Num. matches"===k.column&&
0<k.value?r.attr("class","green-alert"):"Num. matches"===k.column&&0===k.value&&r.attr("class","green-alert")}).html(function(k){return k.value}))})};
MetagenomicsController.prototype._drawSuperSimpleTable=function(e){console.log("hello");var a,d,g,h,c,l,f=["Experiment Result","Explanation"],p=getSelectedBarcode("Metagenomics").replace(" ","_");this._axiosInstance.get("/api/v1/metagenomics/"+e+"/simple-alert/"+p).then(function(m){if(204===m.status)d3.select("#simple-validation").remove(),d3.select("#analysis").classed("show",!0);else{l=m.data;console.log(l);a=(m=d3.select(".super-simple-alert-table").classed("has-tabley?"))?d3.select(".super-simple-alert-table").select("table"):
d3.select(".super-simple-alert-table").classed("has-tabley?",!0).style("width","100%").append("table").attr("class","table simple-map-alert");d=m?a.select("thead"):a.append("thead").append("tr");g=m?a.select("tbody"):a.append("tbody").attr("class","simple-alert-tbody");d.selectAll("th").data(f).enter().append("th").attr("class",function(b,k){return k}).style("width",function(b){return"33%"}).text(function(b){return b});h=g.selectAll("tr");h.data(l).enter().append("tr").attr("id",function(b,k){console.log(b);
return k}).style("height","3rem");h.data(l).exit().remove();h=g.selectAll("tr");c=h.selectAll("td");c.data(function(b){return f.map(function(k){return{column:k,value:b[k]}})}).enter().append("td");c=h.selectAll("td");c.data(function(b){return f.map(function(k){return{column:k,alert:b.Alert,runStatus:b.run_status,runStatusReasons:b.run_status_reasons,alertReason:b.alert_reasons}})}).attr("id",function(b,k){return f[k].replace(" ","_")}).style("width",function(b){return"Experiment Result"===b.column?
"33%":"66%"});m=l[0];var n=d3.select("#Experiment_Result").classed("circled")?d3.select(".alerty"):d3.select("#Experiment_Result").attr("class","circled").append("div").classed("alerty",!0),q=d3.select("#Explanation").classed("listed")?d3.select("#reason"):d3.select("#Explanation").attr("class","listed").append("ul").attr("id","reason");m.Alert||m.run_status?m.run_status?n.style("background-color","rgba(255, 191, 0, 0.9)"):!m.run_status&&m.Alert&&n.style("background-color","rgba(255, 0, 0, 0.7)"):
n.style("background-color","rgba(0, 128, 0, 0.7)");m.run_status?(q.selectAll("li").data(m.run_status_reasons).exit().remove(),q.selectAll("li").data(m.run_status_reasons).enter().append("li").html(function(b){console.log(b);return""+b})):m.Alert&&(q.selectAll("li").data(m.alert_reasons).exit().remove(),q.selectAll("li").data(m.alert_reasons).enter().append("li").html(function(b){return""+b}))}});this._revealMetagenomicsPage()};
MetagenomicsController.prototype._drawSimpleTable=function(e){var a=this,d,g,h,c,l,f,p,m=["Status","Low probability","Validation species","Detected"],n=getSelectedBarcode("Metagenomics");this._axiosInstance.get("/api/v1/metagenomics/alerts",{params:{flowcellId:e,barcode:n}}).then(function(q){204===q.status?(d3.select("#validation").remove(),d3.select("#analysis").classed("show",!0)):(f=q.data.table,p=q.data.conf_detect_limit,f.sort(a._compare2),d=(q=d3.select(".simple-alert-table").classed("has-tabley?"))?
d3.select(".simple-alert-table").select("table"):d3.select(".simple-alert-table").classed("has-tabley?",!0).style("width","100%").append("table").attr("class","table map-alert"),g=q?d.select("thead"):d.append("thead").append("tr"),h=q?d.select("tbody"):d.append("tbody").attr("class","alert-tbody"),g.selectAll("th").data(m).enter().append("th").style("text-align","center").attr("id",function(b){return b.replace(" ","_")}).attr("class",function(b,k){return k}).style("width",function(b){if("Status"===
b)return"10%"}).text(function(b){return b}),c=h.selectAll("tr"),c.data(f).enter().append("tr").attr("id",function(b){return b["Validation species"].replace(/ /g,"_")}),c.data(f).exit().remove(),c=h.selectAll("tr"),l=c.selectAll("td"),l.data(function(b){return m.map(function(k){return{column:k,value:b[k]}})}).enter().append("td"),l=c.selectAll("td"),l.data(function(b){return m.map(function(k){return{column:k,value:b[k],read_count:b.read_count,detected:b.Detected,species:b["Validation species"],conf_limit:b.conf_limit,
detected_at:b.detected_at}})}).attr("id",function(b,k){return m[k].replace(" ","_")}).style("background-color",function(b){if("Status"===b.column&&!1===b.detected)return"green";if("Status"===b.column&&!0===b.detected)return"rgba(255, 0, 0, 0.7)"}).html(function(b){d3.select("#Validation species").html("Validation species");if("Low probability"===b.column&&!1===b.detected&&5E4<=b.conf_limit)return d3.select("#Low_probability").html("Low risk, less than 1 in "+p+" reads"),b.species;if("Validation species"===
b.column&&!1===b.detected&&5E4>b.conf_limit)return d3.select("#Potential_threats").html("Validation species (< 1 in "+p+" reads)"),b.species;if("Detected"===b.column&&!0===b.detected)return b.species+" (1 in "+b.detected_at+" reads)"}))})};
MetagenomicsController.prototype._drawSankeyDiagram=function(e,a,d,g,h,c){var l=d.append("g");a(e);l.attr("class","links").attr("fill","none").attr("stroke-opacity",.5).selectAll("path").data(e.links).join("path").attr("d",d3.sankeyLinkHorizontal()).attr("stroke",function(f,p){return h(f.path)}).attr("stroke-width",function(f){return Math.max(.5,f.width)}).append("title").text(function(f){return f.source.name+" \u2192 "+f.target.name+"\n"+g(f.value)});d.append("g").attr("class","nodes").selectAll("rect").data(e.nodes).enter().append("rect").attr("x",
function(f){return f.x0}).attr("y",function(f){return f.y0}).attr("height",function(f){return f.y1-f.y0}).attr("width",function(f){return f.x1-f.x0}).attr("fill",function(f){return h(f.path)}).append("title").text(function(f){return f.name+"\n"+g(f.value)});d.append("g").attr("class","text").style("font","10px sans-serif").selectAll("text").data(e.nodes).enter().append("text").attr("x",function(f){return f.x0<c/2?f.x1+6:f.x0-6}).attr("y",function(f){return(f.y1+f.y0)/2}).attr("dy","0.35em").attr("text-anchor",
function(f){return f.x0<c/2?"start":"end"}).text(function(f){return f.name})};
MetagenomicsController.prototype._updateSankey=function(e,a,d,g,h,c,l,f,p){var m=this;this._axiosInstance.get("/api/v1/metagenomics/sankey",{params:{flowcellId:e,barcode:p}}).then(function(n){var q=n.data.sankey;n=n.data.run;console.log(n);void 0===q&&!0===n?(g.select(".contain").selectAll("*").remove(),g.append("text").text("No data to display").attr("text-anchor","middle").attr("x","50%").attr("y","50%")):!1!==n&&(!0===n&&d3.select(".sankeyContainer").style("display","block"),g.select(".contain").selectAll("*").remove(),
m._drawSankeyDiagram(q,a,h,c,l,f))})["catch"](function(n){console.error(n)})};
MetagenomicsController.prototype._initialiseSankey=function(e){var a=getSelectedBarcode("Metagenomics"),d=.6*$(window).height(),g=$(window).width()-120,h=d3.format(",.0f"),c=d3.scaleOrdinal(d3.schemeCategory10);d=d3.max([d,480]);var l=d3.sankey().nodeWidth(20).nodePadding(3).size([g,.95*d]).nodeId(function(p){return p.name});if($(".svg-sankey").length){d=d3.select(".svg-sankey");var f=d3.select(".contain")}else d=d3.select(".svg-container").append("svg").attr("width",g).attr("class","svg-sankey").attr("height",
d),f=d.append("g").attr("class","contain");this._updateSankey(e,l,!0,d,f,function(p){return h(p)+" Reads"},c,g,a)};