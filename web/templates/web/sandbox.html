<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <style>
        .principal {
            width: 100%;
            height: 600px;
        }

        .detail_chart {
            width: 95%;
            height: 200px;
        }
        .master_chart {
            width: 95%;
            height: 70px;
        }
    </style>
</head>
<body>

<form>
    run <input type="text" id="run-id"/>
    <select id="chromosome-id-select"></select>
</form>

<div id="teste_div" class="principal">
    <div id="teste_div_detail" class="detail_chart"></div>
    <div id="teste_div_master" class="master_chart"></div>
</div>

<div id="container2">container2</div>
<div id="container" style="height: 400px; min-width: 310px">container</div>



<script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/modules/exporting.js"></script>
<!-- <script src="https://code.highcharts.com/stock/highstock.js"></script> -->
<!-- <script src="https://code.highcharts.com/stock/modules/exporting.js"></script> -->
<script>

    function requestMappedChromosomes(run_id) {
        /*
         * Request the chromosomes that have reads mapped to using minimap2
         * and update the select box on tab Mapping
         *
         */

        var url = '/api/v1/runs/' + run_id + '/references';

        $.getJSON(url, function (data_unsorted) {

            var data = data_unsorted.sort(function (a, b) {
                return a['barcode_name'] - ['b.barcode_name'];
            });

            var select = document.getElementById('chromosome-id-select');
            var selected_index = select.selectedIndex;
            var selected_option = select[selected_index];

            while (select.length > 0) {
                select.remove(0);
            }

            for (var i = 0; i < data.length; i++) {
                var option = document.createElement('option');

                var value_combination = data[i]['run_id'] + '_' + data[i]['barcode_id'] + '_' + data[i]['read_type_id'] + '_' + data[i]['reference_id'] + '_' + data[i]['chromosome_id'];

                option.text = data[i]['barcode_name'] + ' - ' + data[i]['read_type_name'] + ' - ' + data[i]['reference_name'] + ' - ' + data[i]['chromosome_name'];
                option.value = value_combination;

                if (selected_option === undefined) {

                } else {

                    if (value_combination == selected_option.value) {
                        option.selected = 'selected';
                    }

                }

                select.add(option);
            }

        });

    }

    document.getElementById("run-id").addEventListener("change", function () {
        const valor = document.getElementById("run-id").value;
        requestMappedChromosomes(valor);
        console.log(valor);
    });

    document.getElementById("chromosome-id-select").addEventListener("change", function () {
        //const valor = document.getElementById("chromosome-id-select").value;
        //requestMappedChromosomes(valor);
        //console.log(valor);
        initialiseChart3();
    });


    var master_chart;
    var detail_chart;

    function afterSetExtremes(e) {
        console.log('inside aftersetextremes...');

        var select = document.getElementById('chromosome-id-select');
        var selected_index = select.selectedIndex;
        var selected_option = select[selected_index];

        if (selected_option === undefined) {
            console.log('No mapped chromosome selected.');
            return;
        }

        var value_combination = selected_option.value.split('_');
        var run_id = value_combination[0];
        var barcode_id = value_combination[1];
        var read_type_id = value_combination[2];
        var reference_id = value_combination[3];
        var chromosome_id = value_combination[4];

        var url = '/api/v1/runs/' + run_id + '/pafcover/' + barcode_id + '/' + read_type_id + '/' + chromosome_id + '/' + Math.round(e.min) + '/' + Math.round(e.max) + '/';

        /**
        * Load new data depending on the selected min and max
        */

        console.log(e);
        console.log(e.min);
        console.log(e.max);

        if (e.userMin === undefined || e.userMax === undefined) {
            console.log('e.min or e.max is null');
        }

        var chart = Highcharts.charts[1];

        chart.showLoading('Loading data from server...');


        $.getJSON(url, function (data) {

            chart.series[0].setData(data);
            chart.hideLoading();
        });
    }

    function initialiseChart3() {

        var select = document.getElementById('chromosome-id-select');
        var selected_index = select.selectedIndex;
        var selected_option = select[selected_index];

        if (selected_option === undefined) {
            console.log('No mapped chromosome selected.');
            return;
        }

        var value_combination = selected_option.value.split('_');
        var run_id = value_combination[0];
        var barcode_id = value_combination[1];
        var read_type_id = value_combination[2];
        var reference_id = value_combination[3];
        var chromosome_id = value_combination[4];

        var url = '/api/v1/runs/' + run_id + '/pafcover/' + barcode_id + '/' + read_type_id + '/' + chromosome_id + '/';

        $.getJSON(url, function (data) {
            var detailChart;

            function afterSelection(event) {
                event.preventDefault();

                // console.log(event);
                console.log(event.target.renderTo.id)
                return;

                var extremesObject = event.xAxis[0];
                var min = extremesObject.min;
                var max = extremesObject.max;
                var detailData = [];
                var xAxis = this.xAxis[0];

                // reverse engineer the last part of the data
                $.each(this.series[0].data, function () {
                    if (this.x > min && this.x < max) {
                        detailData.push([this.x, this.y]);
                    }
                });

                // move the plot bands to reflect the new detail span
                xAxis.removePlotBand('mask-before');
                xAxis.addPlotBand({
                    id: 'mask-before',
                    from: data[0][0],
                    to: min,
                    color: 'rgba(0, 0, 0, 0.2)'
                });

                xAxis.removePlotBand('mask-after');
                xAxis.addPlotBand({
                    id: 'mask-after',
                    from: max,
                    to: data[data.length - 1][0],
                    color: 'rgba(0, 0, 0, 0.2)'
                });


                detailChart.series[0].setData(detailData);

                /*return false;*/
            }

            // create the detail chart
            function createDetail(masterChart) {

                // prepare the detail chart
                var detailData = [];
                var detailStart = data[0][0];

                $.each(masterChart.series[0].data, function () {
                    //console.log('x: ' + this.x);
                    //console.log('y: ' + this.y);
                    if (this.x >= detailStart) {
                        detailData.push([this.x, this.y]);
                    }
                });

                console.log('--->');
                console.log(data);
                console.log(detailStart);
                console.log(detailData);
                console.log('<---');

                // create a detail chart referenced by a global variable
                detailChart = Highcharts.chart('detail-container', {
                    chart: {
                        marginBottom: 120,
                        reflow: false,
                        marginLeft: 50,
                        marginRight: 20,
                        style: {
                            position: 'absolute'
                        },
                        step: true,
                        zoomType: 'x',
                        events: {
                            selection: afterSelection
                        }
                    },
                    credits: {
                        enabled: false
                    },
                    title: {
                        text: null
                    },
                    xAxis: {
                        type: 'line',
                        // events: {
                        //     afterSetExtremes: afterSetExtremes
                        // }
                    },
                    yAxis: {
                        title: {
                            text: null
                        },
                        maxZoom: 0.1
                    },
                    legend: {
                        enabled: false
                    },
                    plotOptions: {
                        series: {
                            marker: {
                                enabled: false,
                                states: {
                                    hover: {
                                        enabled: true,
                                        radius: 3
                                    }
                                }
                            }
                        }
                    },
                    series: [{
                        name: null,
                        pointStart: detailStart,
                        data: detailData,
                        step: true
                    }],

                    exporting: {
                        enabled: false
                    }

                }); // return chart
            }

            // create the master chart
            function createMaster() {
                console.log('inside master');
                console.log('data[0]:' + data[0]);
                console.log('data[0][0]:' + data[0][0]);
                Highcharts.chart('master-container', {
                    chart: {
                        reflow: false,
                        borderWidth: 0,
                        backgroundColor: null,
                        marginLeft: 50,
                        marginRight: 20,
                        zoomType: 'x',
                        step: true,
                        events: {

                            // listen to the selection event on the master chart to update the
                            // extremes of the detail chart
                            selection: afterSelection
                        }
                    },
                    title: {
                        text: null
                    },
                    xAxis: {
                        type: 'line',
                        showLastTickLabel: true,
                        plotBands: [{
                            id: 'mask-before',
                            from: data[0][0],
                            to: data[data.length - 1][0],
                            color: 'rgba(0, 0, 0, 0.2)'
                        }],
                        title: {
                            text: null
                        }
                    },
                    yAxis: {
                        gridLineWidth: 0,
                        labels: {
                            enabled: false
                        },
                        title: {
                            text: null
                        },
                        min: 0.6,
                        showFirstLabel: false
                    },
                    legend: {
                        enabled: false
                    },
                    credits: {
                        enabled: false
                    },
                    plotOptions: {
                        series: {
                            fillColor: {
                                // linearGradient: [0, 0, 0, 70],
                                stops: [
                                    [0, Highcharts.getOptions().colors[0]],
                                    [1, 'rgba(255,255,255,0)']
                                ]
                            },
                            lineWidth: 1,
                            marker: {
                                enabled: false
                            },
                            shadow: false,
                            states: {
                                hover: {
                                    lineWidth: 1
                                }
                            },
                            enableMouseTracking: false
                        }
                    },

                    series: [{
                        type: 'area',
                        name: null,
                        pointStart: data[0][0],
                        data: data,
                        step: true
                    }],

                    exporting: {
                        enabled: false
                    }

                }, function (masterChart) {
                    createDetail(masterChart);
                }); // return chart instance
            }

            // make the container smaller and add a second container for the master chart
            var $container = $('#container2')
                .css('position', 'relative');

            $('<div id="detail-container">')
                .appendTo($container);

            $('<div id="master-container">')
                .css({
                    position: 'absolute',
                    top: 300,
                    height: 100,
                    width: '100%'
                })
                .appendTo($container);

            // create master and in its callback, create the detail chart
            createMaster();
        });

    }

    function afterSelection(event) {

        event.preventDefault();

        // console.log(event);
        console.log(event.target.renderTo.id)

        var min = Math.trunc(event.xAxis[0].min);
        var max = Math.trunc(event.xAxis[0].max);

        console.log(event);

        var url = create_url() + '?min=' + min + '&max=' + max;

        load_chart_data(url);

        master_chart.xAxis[0].removePlotBand('mask-before');
        master_chart.xAxis[0].addPlotBand({
            id: 'mask-before',
            from: min,
            to: max,
            color: 'rgba(0, 0, 0, 0.2)'
        });

    }

    // create the detail chart
    function createDetail(masterChart) {

        // prepare the detail chart
        var detailData = [];
        var detailStart = data[0][0];

        $.each(masterChart.series[0].data, function () {
            //console.log('x: ' + this.x);
            //console.log('y: ' + this.y);
            if (this.x >= detailStart) {
                detailData.push([this.x, this.y]);
            }
        });

        console.log('--->');
        console.log(data);
        console.log(detailStart);
        console.log(detailData);
        console.log('<---');

        // create a detail chart referenced by a global variable
        detailChart = Highcharts.chart('detail-container', {
            chart: {
                marginBottom: 120,
                reflow: false,
                marginLeft: 50,
                marginRight: 20,
                style: {
                    position: 'absolute'
                },
                step: true,
                zoomType: 'x',
                events: {
                    selection: afterSelection
                }
            },
            credits: {
                enabled: false
            },
            title: {
                text: null
            },
            xAxis: {
                type: 'line',
                // events: {
                //     afterSetExtremes: afterSetExtremes
                // }
            },
            yAxis: {
                title: {
                    text: null
                },
                maxZoom: 0.1
            },
            legend: {
                enabled: false
            },
            plotOptions: {
                series: {
                    marker: {
                        enabled: false,
                        states: {
                            hover: {
                                enabled: true,
                                radius: 3
                            }
                        }
                    }
                }
            },
            series: [{
                name: null,
                pointStart: detailStart,
                data: detailData,
                step: true
            }],

            exporting: {
                enabled: false
            }

        }); // return chart
    }

    function create_url() {

        return "http://localhost:8000/api/v1/flowcells/1/pafcover/2/1/1/";
    }

    function load_chart_data(url, div_main_name) {

        console.log('before getjson');

        console.log(url);

        $.getJSON(url, function (data) {
            console.log(data);

            console.log('length of master: ' + master_chart.series[0].data.length);
            //console.log('length of detail: ' + detail_chart.series[0].data.length);

            console.log('inside geojson');
            console.log(data);

            if (master_chart.series[0].data.length === 0) {
                master_chart.series[0].setData(data);
            }

            min_extreme = data[0][0];
            max_extreme = data[19][0];
            // min_extreme = data[0][0] + (data[19][0] - data[0][0])/2;
            // max_extreme = data[19][0] - (data[19][0] - data[0][0])/2;

            if (detail_chart) {
                detail_chart.destroy();
            }

            detail_chart = create_detail_chart(div_main_name);

            //detail_chart.xAxis[0].setExtremes(min_extreme, max_extreme);
            detail_chart.series[0].setData(data);
            //detail_chart.series[0].pointStart = data[0][0]

            //detail_chart.redraw();
            return data;

        });

        console.log('after getjson');

    }

    function create_detail_chart(div_main_name) {

        var div_detail_name = 'teste_div_detail';
        //var div_detail_name = div_main_name + "_detail";
        console.log("detail div name: " + div_detail_name);

        var detail_container = document.getElementById(div_detail_name);

        var chart = Highcharts.chart({
            chart: {
                renderTo: detail_container,
                reflow: false,
                marginLeft: 50,
                marginRight: 20,
                style: {
                    position: 'absolute'
                },
                step: true,
                zoomType: 'x',
                events: {
                    selection: afterSelection
                }
            },
            credits: {
                enabled: false
            },
            title: {
                text: null
            },
            xAxis: {
                type: 'line',
                // events: {
                //     afterSetExtremes: afterSetExtremes
                // }
            },
            yAxis: {
                title: {
                    text: null
                },
                maxZoom: 0.1,
                min: 0
            },
            legend: {
                enabled: false
            },
            plotOptions: {
                series: {
                    marker: {
                        enabled: false,
                        states: {
                            hover: {
                                enabled: true,
                                radius: 3
                            }
                        }
                    }
                }
            },
            series: [{
                name: null,
                //pointStart: detailStart,
                data: [],
                step: true
            }],

            exporting: {
                enabled: false
            }

        });

        return chart;

    }

    function create_master_chart(master_div) {

        var chart = new Highcharts.chart({
            chart: {
                renderTo: master_div,
                reflow: false,
                //borderWidth: 0,
                backgroundColor: null,
                marginLeft: 50,
                marginRight: 20,
                zoomType: 'x',
                step: true,
                events: {
                    selection: afterSelection
                }
            },
            title: {
                text: null
            },
            xAxis: {
                type: 'line',
                showLastTickLabel: true,
                plotBands: [{
                    id: 'mask-before',
                    //from: data[0][0],
                    //to: data[data.length - 1][0],
                    color: 'rgba(0, 0, 0, 0.2)'
                }],
                title: {
                    text: null
                }
            },
            yAxis: {
                title: {
                    text: null
                },
                visible: false
            },
            legend: {
                enabled: false
            },
            credits: {
                enabled: false
            },
            plotOptions: {
                series: {
                    fillColor: {
                        // linearGradient: [0, 0, 0, 70],
                        stops: [
                            [0, Highcharts.getOptions().colors[0]],
                            [1, 'rgba(255,255,255,0)']
                        ]
                    },
                    lineWidth: 1,
                    marker: {
                        enabled: false
                    },
                    shadow: false,
                    states: {
                        hover: {
                            lineWidth: 1
                        }
                    },
                    enableMouseTracking: false
                }
            },

            series: [{
                type: 'area',
                name: null,
                //pointStart: data[0][0],
                data: [],
                step: true
            }],

            exporting: {
                enabled: false
            }

        });

        return chart;

    }

    function create_master_detail_chart(div_name) {

        var div_main_name = div_name;
        var div_master_name = div_main_name + "_master";
        // var div_detail_name = div_main_name + "_detail";

        // var detail_container = document.getElementById(div_detail_name);
        var master_container = document.getElementById(div_master_name);
        var main_container = document.getElementById(div_main_name);

        master_chart = create_master_chart(master_container);
        //detail_chart = create_detail_chart(detail_container);

        var url = create_url();

        load_chart_data(url, div_main_name);

        console.log('done');
    }

    $( document ).ready(function() {
        create_master_detail_chart('teste_div');
    });


</script>


</body>
</html>
