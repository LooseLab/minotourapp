{% extends "web/template_private.html" %}
{% load static %}

{% block content %}
    <div class="content-wrapper" id="app">

        <!-- Content Header (Page header) -->
        <section class="content-header">
            <h1>
                Previous Summary
                <small> -</small>
            </h1>
            <ol class="breadcrumb">
                <li><a href="#"><i class="fa fa-table"></i> previous run</a></li>
                <li><a href="#"><i class="fa fa-bar-chart-o"></i> Data Summary</a></li>
                <li class="active">Here</li>
            </ol>
        </section>

        <!-- Main content -->
        <section class="content">
            <div class="box">
                <div class="box-header">
                    <h3 class="box-title">Run: ${ minion_run.run_name }</h3>
                </div><!-- /.box-header -->
                <div class="box-body">
                    <div class="row">
                        <button id="counterdown-btn">Reloading in 30 seconds</button>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="nav-tabs-custom">
                                <ul class="nav nav-tabs">
                                    <minionrun-item
                                            v-for="barcode in minion_run.barcodes"
                                            v-bind:barcode="barcode"
                                            v-bind:key="barcode">
                                    </minionrun-item>
                                </ul>
                            </div>

                            <!-- Custom Tabs -->
                            <div class="nav-tabs-custom">
                                <ul class="nav nav-tabs">
                                    <li><a href="#" v-on:click="setActiveTab('read-summaries-tab', $event)">Read Summaries</a></li>
                                    <li><a href="#" v-on:click="setActiveTab('basecaller-summary-tab', $event)">Basecaller Summary</a></li>
                                    <li><a href="#" v-on:click="setActiveTab('read-histograms-tab', $event)">Read Histograms</a></li>
                                    <li><a href="#" v-on:click="setActiveTab('sequencing-rates-tab', $event)">Sequencing Rates</a></li>
                                    <li><a href="#" v-on:click="setActiveTab('pore-activity-tab', $event)">Pore Activity</a></li>
                                    <li><a href="#" v-on:click="setActiveTab('read-quality-tab', $event)">Read Quality</a></li>
                                    <li><a href="#" v-on:click="setActiveTab('coverage-detail-tab', $event)">Coverage Detail</a></li>
                                    <li><a href="#" v-on:click="setActiveTab('base-coverage-tab', $event)">Base Coverage</a></li>
                                </ul>




                                <div class="tab-content">
                                    <div class="tab-pane active" id="tab_1" v-show="isActiveTab('read-summaries-tab')">
                                        <div class="panel panel-default">
                                            <div class="panel-heading">
                                                <h3 class="panel-title"><!-- Button trigger modal -->
                                                    <button class="btn btn-info" data-toggle="modal"
                                                            data-target="#modal1">
                                                        <i class="fa fa-info-circle"></i> Reads And Coverage Summary
                                                    </button>

                                                    <!-- Modal -->
                                                    <div class="modal fade" id="modal1" tabindex="-1" role="dialog"
                                                         aria-labelledby="myModalLabel" aria-hidden="true">
                                                        <div class="modal-dialog">
                                                            <div class="modal-content">
                                                                <div class="modal-header">
                                                                    <button type="button" class="close"
                                                                            data-dismiss="modal"><span
                                                                            aria-hidden="true">&times;</span><span
                                                                            class="sr-only">Close</span>
                                                                    </button>
                                                                    <h4 class="modal-title" id="myModalLabel">Reads
                                                                        And Coverage Summary</h4>
                                                                </div>
                                                                <div class="modal-body">
                                                                    This panel provides information on the number of
                                                                    reads of each type generated by the metrichor
                                                                    analysis. The avergae read lengths and the
                                                                    maximum read length for each are shown.<br><br>
                                                                    Where a reference sequence is available for
                                                                    mapping, the proportion of the reference covered
                                                                    by reads is shown as "Percentage of Reference
                                                                    with Read".<br><br>
                                                                    The average depth of sequencing over these
                                                                    positions is shown as "Average Depth Of
                                                                    Sequenced Positions".<br>
                                                                </div>
                                                                <div class="modal-footer">
                                                                    <button type="button" class="btn btn-default"
                                                                            data-dismiss="modal">Close
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </h3>
                                            </div>
                                            <div class="panel-body">
                                                <div class="row">
                                                    <show-chart
                                                            chartid="reads-called"
                                                            :mybarcode='selectedBarcode'
                                                            :id="id"
                                                            :minion_run="minion_run"
                                                            title="reads called"
                                                            ytitle="number of reads called">
                                                    </show-chart>

                                                    <show-chart
                                                            chartid="yield"
                                                            :mybarcode='selectedBarcode'
                                                            :id="id"
                                                            :minion_run="minion_run"
                                                            title="yield"
                                                            ytitle="yield">
                                                    </show-chart>

                                                    <show-chart
                                                            chartid="average-read-length"
                                                            :mybarcode='selectedBarcode'
                                                            :id="id"
                                                            :minion_run="minion_run"
                                                            title="average read length"
                                                            ytitle="average read length">
                                                    </show-chart>

                                                    <show-chart
                                                            chartid="maximum-read-length"
                                                            :mybarcode='selectedBarcode'
                                                            :id="id"
                                                            :minion_run="minion_run"
                                                            title="maximum read length"
                                                            ytitle="maximum read length">
                                                    </show-chart>

                                                    <!--<div class="col-md-12" id="boxplotlength" style="height:400px;">
                                                        <i class="fa fa-cog fa-spin fa-3x"></i> Calculating Box
                                                        Plots
                                                    </div>-->
                                                </div>
                                                <div class="row">
                                                    <show-chart-spline
                                                            chartid="average-read-lengths-overtime"
                                                            title="average read lengths over time"
                                                            ytitle="average read length"
                                                            :chart_data="summary_by_minute"
                                                            :mybarcode='selectedBarcode'
                                                            :id="id"
                                                            :minion_run="minion_run">
                                                    </show-chart-spline>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="panel panel-default">
                                            <div class="panel-heading">Run Summary</div>
                                            <div class="panel-body">

                                            </div>
                                        </div>


                                    </div>
                                    <!-- /.col-lg-12 -->
                                    <!-- /.tab-pane -->


                                    <div class="tab-pane active" id="tab_1" v-show="isActiveTab('basecaller-summary-tab')">
                                        <div class="panel panel-default">
                                            <div class="panel-heading">
                                                <h3 class="panel-title"><!-- Button trigger modal -->
                                                    <button class="btn btn-info" data-toggle="modal"
                                                            data-target="#modal1">
                                                        <i class="fa fa-info-circle"></i> XXXXXX
                                                    </button>
                                                </h3>
                                            </div>
                                            <div class="panel-body">
                                                <div class="row">
                                                </div>
                                            </div>
                                        </div>

                                    </div>
                                </div>
                                <!-- /.tab-content -->
                            </div>
                            <!-- nav-tabs-custom -->
                        </div>
                        <!-- /.col -->
                        <!-- /.col -->
                    </div>
                </div>
            </div>
        </section><!-- /.content -->
    </div><!-- /.content-wrapper -->


    <!-- Vue Templates -->
    <template id="chart">
        <div class="col-md-6 highcharts" style="width:25%; height:400px;">
            <i class="fa fa-cog fa-spin fa-3x"></i> Calculating Read Numbers
        </div>
    </template>

    <template id="chart-spline">
        <div style="height:400px;">
            <i class="fa fa-cog fa-spin fa-3x"></i> Read Lengths Over Time.
        </div>
    </template>


    <script>
        console.log('before vue');

        Vue.component('minionrun-item', {
            delimiters: ['${', '}'],
            props: ['barcode'],
            template: "<li><a v-on:click='loadChartsByBarcode(barcode)' href='#'>${ barcode }</a></li>",
            methods: {
                loadChartsByBarcode: function (mybarcode) {
                    app.selectedBarcode = mybarcode;
                }
            }

        });

        Vue.component('show-chart-spline', {
            template: '#chart-spline',
            props: ['chartid', 'mybarcode', 'id', 'title', 'ytitle', 'minion_run', 'chart_data'],
            data: function () {
                return {
                    counter: 0,
                    chart: null,
                    opts: {
                        chart: {
                            type: 'spline',
                            animation: false
                        },
                        title: {
                            text: this.title
                        },
                        yAxis: {
                            title: {
                                text: this.ytitle
                            }
                        },
                        xAxis: {
                            type: 'datetime'
                        }
                    }
                };
                return {
                    chart: undefined
                }
            },
            mounted() {
                if (!this.chart && this.opts) {
                    let _Highcharts = this.Highcharts || Highcharts;
                    this.chart = new _Highcharts.Chart(this.$el, this.opts);
                }
            },
            watch: {
                mybarcode: function (mybarcode) {
                    console.log('updated barcode ' + this.mybarcode);
                    this.redraw();
                },
                minion_run: function () {
                    console.log('--- minion run changed : ' + this._uid + ' ---');
                    this.redraw();
                },
                chart_data: function () {
                    this.redraw();
                }
            },
            beforeDestroy() {
                if (this.chart) {
                    this.chart.destroy();
                }
            },
            methods: {
                redraw() {
                    if (this.chart_data == null) {
                        console.log('---- chart_data is null ----');

                    } else {
                        console.log('---- chart_data is NOT null ----');

                        var chart_data = this.chart_data;

                        // Remove previous series
                        while (this.chart.series.length > 0) {
                            this.chart.series[0].remove();
                        }

                        this.chart.colorCounter = 0;
                        this.chart.symbolCounter = 0;

                        var summaries = [];
                        if (this.mybarcode == 'All reads') {

                            for (var i = 0; i < chart_data.length; i++) {
                                var average_read_length = chart_data[i].total_length / chart_data[i].read_count;
                                var sample_time = new Date(chart_data[i].sample_time);

                                var point = {
                                    x: sample_time,
                                    y: average_read_length
                                }

                                summaries.push(point);
                            }
                        } /*else {
                            for (var i = 0; i < chart_data.length; i++) {
                                var item = chart_data[i];
                                if (item.barcode == this.mybarcode) {
                                    //summaries.push(item);
                                    var average_read_length = item.total_length / item.read_count;
                                    //var sample_date = chart_data[i].sample_date;
                                    var sample_date = time + i * 1000 * 60 * 60 * 24    ;
                                    this.chart.series[0].addPoint([sample_date, average_read_length], true, false);

                                }
                            }
                        }*/

                        summaries.sort(function(a, b) {
                            return a.x - b.x;
                        })

                        this.chart.addSeries({name: '', data: summaries});
                    }
                }
            }
        })
        ;

        Vue.component('show-chart', {
            template: '#chart',
            props: ['chartid', 'mybarcode', 'id', 'title', 'ytitle', 'minion_run'],
            data: function () {
                return {
                    counter: 0,
                    chart: null,
                    opts: {
                        chart: {
                            type: 'column',
                            animation: false
                        },
                        title: {
                            text: this.title
                        },
                        yAxis: {
                            title: {
                                text: this.ytitle
                            }
                        },
                    }
                };
                return {
                    chart: undefined
                }
            },
            // lifecycle hooks - ref: https://alligator.io/vuejs/component-lifecycle/
            // created() { console.log('inside created event of the component show-chart'); },
            // beforeUpdate() { console.log('inside updated event of the component show-chart. mybarcode is ' + this.mybarcode); },
            mounted() {
                console.log('inside mounted event of the component show-chart');
                if (!this.chart && this.opts) {
                    this._init();
                }
            },
            watch: {
                mybarcode: function (mybarcode) {
                    console.log('updated barcode ' + this.mybarcode);
                    this.redraw();
                },
                //opts: function (opts) {
                //    if (!this.getChart() && opts) {
                //        this._init()
                //    } else {
                //        this.getChart().update(this.opts);
                //    }
                //},
                minion_run: function () {
                    console.log('--- minion run changed : ' + this._uid + ' ---');
                    this.redraw();
                }
            },
            beforeDestroy() {
                if (this.chart) {
                    this.chart.destroy();
                }
            },
            methods: {
                _init() {
                    console.log('inside _init method of the component');
                    if (!this.chart && this.opts) {
                        let _Highcharts = this.Highcharts || Highcharts;
                        this.chart = new _Highcharts.Chart(this.$el, this.opts);
                        //this.get_data();
                    }
                },
                //get_data() {
                //    console.log('inside get data');
                //    this.opts.series[0] = [20]
                //    this.chart.update(this.opts);
                //},
                redraw() {
                    var minion_run = this.minion_run;

                    // Remove previous series
                    while (this.chart.series.length > 0) {
                        this.chart.series[0].remove();
                    }

                    this.chart.colorCounter = 0;
                    this.chart.symbolCounter = 0;

                    var summaries = [];
                    if (this.mybarcode == 'All reads') {
                        for (var i = 0; i < minion_run.runsummaries.length; i++) {
                            summaries.push(minion_run.runsummaries[i]);
                        }

                    } else {
                        for (var i = 0; i < minion_run.runsummariesbarcodes.length; i++) {
                            var item = minion_run.runsummariesbarcodes[i];
                            if (item.barcode == this.mybarcode) {
                                summaries.push(item);
                            }
                        }
                    }

                    for (var i = 0; i < summaries.length; i++) {
                        var value = 0;

                        if (this.chartid == 'reads-called') {
                            value = summaries[i].read_count;
                        } else if (this.chartid == 'yield') {
                            value = summaries[i].total_length;
                        } else if (this.chartid == 'average-read-length') {
                            value = summaries[i].total_length / summaries[i].read_count;
                        } else if (this.chartid == 'maximum-read-length') {
                            value = summaries[i].max_length;
                        }

                        var series = {
                            'name': summaries[i].typename,
                            'data': [value],
                            'animation': false,
                        }

                        this.chart.addSeries(series);
                    }
                }
            }
        });

        var app = new Vue({
            delimiters: ['${', '}'],
            el: "#app",
            data: {
                minion_run: '',
                id: {{ minion_run.id }},
                selectedBarcode: '',
                selectedTab: 'read-summaries',
                newdata: null,
                summary_by_minute: null,
                summary_barcode_by_minute: null
            },
            created: function () {
                this.requestInitialData();
            },
            methods: {
                requestInitialData() {
                    console.log('inside request initial data');

                    var url_run = '/api/v1/runs/' + this.id;
                    var promise_run = this.$http.get(url_run);
                    promise_run
                        .then(function (res) {
                            console.log(res.json());
                            return res.json();
                        })
                        .then(function (minion_run) {
                            this.selectedBarcode = 'All reads';
                            this.minion_run = minion_run;
                            this.minion_run.barcodes = this.minion_run.barcodes.sort()
                        });

                    url_run = '/api/v1/runs/' + this.id + '/summarybyminute';
                    promise_run = this.$http.get(url_run);
                    promise_run
                        .then(function (res) {
                            return res.json();
                        })
                        .then(function (summarybyminute) {
                            this.summary_by_minute = summarybyminute;
                            console.log('---- summary by minute ----');
                            console.log(summarybyminute);
                            console.log('---- summary by minute ----');
                        });

                    //this.counterDown();

                },
                requestData() {
                    console.log('inside request data');

                    var url_run = '/api/v1/runs/' + this.id;
                    var promise_run = this.$http.get(url_run);
                    promise_run
                        .then(function (res) {
                            console.log(res.json());
                            return res.json();
                        })
                        .then(function (minion_run) {
                            this.minion_run = minion_run;
                            //this.minion_run.barcodes = this.minion_run.barcodes.sort()
                        });

                    //this.counterDown();

                },
                counterDown() {
                    var counter = 10;
                    setInterval(function () {
                        counter--;

                        if (counter >= 0) {
                            btn = document.getElementById('counterdown-btn');
                            btn.innerHTML = 'Reloading in ' + counter;
                        }

                        if (counter === 0) {
                            //clearInterval(counter);
                            console.log('time to requestData');
                            this.requestData();

                        }
                    }.bind(this), 1000);
                },
                setActiveTab: function(val, event) {
                    var tabs = event.target.parentNode.parentNode.children;
                    for (var i = 0; i < tabs.length; i++) {
                        tabs[i].classList.remove('active');
                    }
                    event.target.parentNode.classList.add('active');

                    this.selectedTab = val;
                },
                isActiveTab: function(val) {
                    return this.selectedTab === val;
                }
            }
        });

    </script>

{% endblock %}
