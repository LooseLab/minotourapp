{% extends "web/template_private.html" %}
{% load static %}

{% block content %}
    <div class="content-wrapper" id="app">

        <!-- Content Header (Page header) -->
        <section class="content-header">
            <h1>
                Previous Summary
                <small> -</small>
            </h1>
            <ol class="breadcrumb">
                <li><a href="#"><i class="fa fa-table"></i> previous run</a></li>
                <li><a href="#"><i class="fa fa-bar-chart-o"></i> Data Summary</a></li>
                <li class="active">Here</li>
            </ol>
        </section>

        <!-- Main content -->
        <section class="content">
            <div class="box">
                <div class="box-header">
                    <h3 class="box-title">Run: ${ minion_run.run_name }</h3>
                </div><!-- /.box-header -->
                <div class="box-body">
                    <div class="row">
                        <div class="col-md-12">
                            <div class="nav-tabs-custom">
                                <ul class="nav nav-tabs">
                                    <minionrun-item
                                            v-for="barcode in minion_run.barcodes"
                                            v-bind:barcode="barcode"
                                            v-bind:key="barcode">
                                    </minionrun-item>
                                </ul>
                            </div>

                            <!-- Custom Tabs -->
                            <div class="nav-tabs-custom">
                                <ul class="nav nav-tabs">
                                    <li class="active"><a href="#">Read Summaries</a></li>
                                    <li><a href="#">Basecaller Summary</a></li>
                                    <li><a href="#">Read Histograms</a></li>
                                    <li><a href="#">Sequencing Rates</a></li>
                                    <li><a href="#">Pore Activity</a></li>
                                    <li><a href="#">Read Quality</a></li>
                                    <li><a href="#">Coverage Detail</a></li>
                                    <li><a href="#">Base Coverage</a></li>
                                </ul>
                                <div class="tab-content">
                                    <div class="tab-pane active" id="tab_1">
                                        <div class="panel panel-default">
                                            <div class="panel-heading">
                                                <h3 class="panel-title"><!-- Button trigger modal -->
                                                    <button class="btn btn-info" data-toggle="modal"
                                                            data-target="#modal1">
                                                        <i class="fa fa-info-circle"></i> Reads And Coverage Summary
                                                    </button>

                                                    <!-- Modal -->
                                                    <div class="modal fade" id="modal1" tabindex="-1" role="dialog"
                                                         aria-labelledby="myModalLabel" aria-hidden="true">
                                                        <div class="modal-dialog">
                                                            <div class="modal-content">
                                                                <div class="modal-header">
                                                                    <button type="button" class="close"
                                                                            data-dismiss="modal"><span
                                                                            aria-hidden="true">&times;</span><span
                                                                            class="sr-only">Close</span>
                                                                    </button>
                                                                    <h4 class="modal-title" id="myModalLabel">Reads
                                                                        And Coverage Summary</h4>
                                                                </div>
                                                                <div class="modal-body">
                                                                    This panel provides information on the number of
                                                                    reads of each type generated by the metrichor
                                                                    analysis. The avergae read lengths and the
                                                                    maximum read length for each are shown.<br><br>
                                                                    Where a reference sequence is available for
                                                                    mapping, the proportion of the reference covered
                                                                    by reads is shown as "Percentage of Reference
                                                                    with Read".<br><br>
                                                                    The average depth of sequencing over these
                                                                    positions is shown as "Average Depth Of
                                                                    Sequenced Positions".<br>
                                                                </div>
                                                                <div class="modal-footer">
                                                                    <button type="button" class="btn btn-default"
                                                                            data-dismiss="modal">Close
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </h3>
                                            </div>
                                            <div class="panel-body">
                                                <div class="row">
                                                        <show-chart
                                                                chartid="reads-called"
                                                                :mybarcode='selectedBarcode'
                                                                :id="id"
                                                                title="reads called"
                                                                ytitle="number of reads called">
                                                        </show-chart>

                                                        <show-chart
                                                                chartid="yield"
                                                                :mybarcode='selectedBarcode'
                                                                :id="id"
                                                                title="yield"
                                                                ytitle="yield">
                                                        </show-chart>

                                                        <show-chart
                                                                chartid="average-read-length"
                                                                :mybarcode='selectedBarcode'
                                                                :id="id"
                                                                title="average read length"
                                                                ytitle="average read length">
                                                        </show-chart>

                                                        <show-chart
                                                                chartid="maximum-read-length"
                                                                :mybarcode='selectedBarcode'
                                                                :id="id"
                                                                title="maximum read length"
                                                                ytitle="maximum read length">
                                                        </show-chart>

                                                        <!--<div class="col-md-12" id="boxplotlength" style="height:400px;">
                                                            <i class="fa fa-cog fa-spin fa-3x"></i> Calculating Box
                                                            Plots
                                                        </div>-->
                                                </div>

                                                <!--<div id="lengthtimewindow" style="height:400px;"><i
                                                        class="fa fa-cog fa-spin fa-3x"></i> Read Lengths Over
                                                    Time.
                                                </div>

                                                <div class="row">
                                                    <?php if ($_SESSION['focusreference'] != "NOREFERENCE") { ?>

                                                    <?php if (count($_SESSION['focusrefnames']) >= 3) {
                                                    //echo "We need something else to handle this bad boy.";?>
                                                    <div class="col-md-6" id="percentcoverageglob"
                                                         style="height:400px;"><i
                                                            class="fa fa-cog fa-spin fa-3x"></i>
                                                        Calculating Reference Coverage for sequences
                                                    </div>
                                                    <div class="col-md-6" id="depthcoverageglob"
                                                         style="height:400px;"><i
                                                            class="fa fa-cog fa-spin fa-3x"></i>
                                                        Calculating Reference Depth for sequences
                                                    </div>
                                                    <?php
                                                            } else { ?>
                                                    <?php var_dump($_SESSION['focusrefnames']); ?>
                                                    <?php foreach ($_SESSION['focusrefnames'] as $key => $value) {
                                                    echo $key . " " . $value . "<br>"; ?>
                                                    <div class="col-md-6"
                                                         id="percentcoverage<?php echo $key; ?>"
                                                         style="height:200px;"><i
                                                            class="fa fa-cog fa-spin fa-3x"></i>
                                                        Calculating Reference Coverage
                                                        for <?php echo $value; ?></div>
                                                    <div class="col-md-6"
                                                         id="depthcoverage<?php echo $key; ?>"
                                                         style="height:200px;"><i
                                                            class="fa fa-cog fa-spin fa-3x"></i>
                                                        Calculating Reference Depth
                                                        for <?php echo $value; ?></div>
                                                    <?php
                                                                }
                                                            }
                                                        } else { ?>
                                                    <div>
                                                        <p class="text-center">
                                                            <small>This dataset has not been aligned to a
                                                                reference sequence.
                                                            </small>
                                                        </p>
                                                    </div>
                                                    <?php }; ?>
                                                </div>-->
                                            </div>
                                        </div>

                                        <div class="panel panel-default">
                                            <div class="panel-heading">Run Summary</div>
                                            <div class="panel-body">

                                            </div>
                                        </div>


                                    </div>
                                    <!-- /.col-lg-12 -->
                                    <!-- /.tab-pane -->
                                </div>
                                <!-- /.tab-content -->
                            </div>
                            <!-- nav-tabs-custom -->
                        </div>
                        <!-- /.col -->
                        <!-- /.col -->
                    </div>
                </div>
            </div>
        </section><!-- /.content -->
    </div><!-- /.content-wrapper -->


    <!-- Vue Templates -->
    <template id="chart">
        <div class="col-md-6 highcharts" style="width:25%; height:400px;">
            <i class="fa fa-cog fa-spin fa-3x"></i> Calculating Read Numbers
        </div>
    </template>


    <script>
        console.log('before vue');

        Vue.component('minionrun-item', {
            delimiters: ['${', '}'],
            props: ['barcode'],
            template: "<li><a v-on:click='selectedBarcode=loadChartsByBarcode(barcode)' href='#'>${ barcode }</a></li>",
            methods: {
                loadChartsByBarcode: function (mybarcode) {
                    console.log(mybarcode);
                    app.selectedBarcode = mybarcode;
                }
            }

        });

        Vue.component('show-chart', {
            template: '#chart',
            props: ['chartid', 'mybarcode', 'id', 'title', 'ytitle'],
            data: function () {
                return {
                    counter: 0,
                    chart: null,
                    opts: {
                        chart: {
                            type: 'column'
                        },
                        title: {
                            text: this.title
                        },
                        xAxis: {
                            categories: ['strand']
                        },
                        yAxis: {
                            title: {
                                text: this.ytitle
                            }
                        },
                        series: [{
                            name: 'template',
                            data: [1]
                        }, {
                            name: 'complement',
                            data: [5]
                        }, {
                            name: '2d',
                            data: [5]
                        }]
                    }
                };
                return {
                    chart: undefined
                }
            },
            // lifecycle hooks - ref: https://alligator.io/vuejs/component-lifecycle/
            created() {
                console.log('inside created event of the component show-chart');
            },
            mounted() {
                console.log('inside mounted event of the component show-chart');
                if (!this.chart && this.opts) {
                    this._init();
                }
            },
            beforeUpdate() {
                console.log('inside updated event of the component show-chart. mybarcode is ' + this.mybarcode);
            },
            watch: {
                mybarcode: function (mybarcode) {
                    console.log('updated barcode ' + this.mybarcode);
                    this.redraw();
                },
                opts: function (opts) {
                    if (!this.getChart() && opts) {
                        this._init()
                    } else {
                        this.getChart().update(this.opts);
                    }
                }
            },
            beforeDestroy() {
                if (this.chart) {
                    this.chart.destroy();
                }
            },
            methods: {
                _init() {
                    console.log('inside _init method of the component');
                    if (!this.chart && this.opts) {
                        let _Highcharts = this.Highcharts || Highcharts;
                        this.chart = new _Highcharts.Chart(this.$el, this.opts);
                        this.get_data();
                    }
                },
                get_data() {
                    console.log('inside get data');
                    this.opts.series[0] = [20]
                    this.chart.update(this.opts);
                },
                redraw() {
                    var url_run = '/api/v1/runs/' + this.id + '/summary/';
                    var promise_run = this.$http.get(url_run);
                    promise_run
                        .then(function (res) {
                            console.log(res.json());
                            return res.json();
                        })
                        .then(function (summaries) {
                            //this.minion_run = minion_run;
                            //this.minion_run.barcodes = this.minion_run.barcodes.sort()
                            console.log('qt the sumaries: ' + summaries.length)
                            console.log(summaries);
                            var series = [];
                            for (var i = 0; i < summaries.length; i++) {
                                var value = 0;

                                if (this.chartid == 'reads-called') {
                                    value = summaries[i].read_count;
                                } else if (this.chartid == 'yield') {
                                    value = summaries[i].total_length;
                                } else if (this.chartid == 'average-read-length') {
                                    value = summaries[i].total_length / summaries[i].read_count;
                                } else if (this.chartid == 'maximum-read-length') {
                                    value = summaries[i].max_length;
                                }

                                var serie = {
                                    'name': summaries[i].typename,
                                    'data': [ value ]
                                }

                                series.push(serie);
                            }
                            this.opts.series = series;
                            this.chart.update(this.opts);

                        });
                    //this.chart.series[0].setData([20], true);
                }
            }
        });

        var app = new Vue({
            delimiters: ['${', '}'],
            el: "#app",
            data: {
                minion_run: '',
                id: {{ minion_run.id }},
                selectedBarcode: '',
                selectedTab: 'read-summaries',
            },
            created: function () {
                var url_run = '/api/v1/runs/' + this.id;
                var promise_run = this.$http.get(url_run);
                promise_run
                    .then(function (res) {
                        console.log(res.json());
                        return res.json();
                    })
                    .then(function (minion_run) {
                        this.minion_run = minion_run;
                        this.minion_run.barcodes = this.minion_run.barcodes.sort()
                    });
            },
            computed: {},
        });
    
    </script>

{% endblock %}
