{% extends "web/template_private.html" %}
{% load static %}

{% block content %}
    <div class="content-wrapper" style="background-color: white">

        <!-- Content Header (Page header) -->
        <section class="content-header">
            <h1>Flowcells <small> - select a Flowcell for more information.</small></h1>
        </section>

        <!-- Main content -->
        <section class="content">
            <!-- Main top nav bar -->

                <div id="messages"></div>

                <div class="box-body">
                    <table id="all-runs" class="table table-bordered table-striped table-hover" style="width:100%" cellspacing="0" >
                    <thead>
                    <tr>
                        <th>#</th>
                        <th>Flowcell<br/>Name</th>
                        <th>Flowcell<br/>Size</th>
                        <th>Sample<br/>Name</th>
                        <th>Start<br/>Time</th>
                        <th>Number<br/>of Reads</th>
                        <th>Number<br/>of Runs</th>
                        <th>Number<br/>of Barcodes</th>
                        <th>Yield</th>
                        <th>Average<br/>Read Length</th>
                        <th>Status</th>
                    </tr>
                    </thead>
                    </table>
                </div>
        </section><!-- /.content -->
    </div><!-- /.content-wrapper -->
{% endblock %}
{% block javascript %}
<script>
    var table_active_runs;
    var table_all_runs;

    $(document).ready(function () {

        table_all_runs = $('#all-runs').DataTable({
            'ajax': {
                'url': "{% url 'flowcell-list' %}",
                'dataSrc': function(jsonData){
                    var json = jsonData.data;
                    var data = [];

                    for (var i = 0; i < json.length; i++){

                        var start_time = new Date(json[i].start_time);
                        var start_time_human_format = start_time.toLocaleString();

                        data.push([
                            json[i].id,
                            json[i].name,
                            json[i].size,
                            json[i].sample_name,
                            start_time_human_format,
                            json[i].number_reads,
                            json[i].number_runs,
                            json[i].number_barcodes,
                            json[i].total_read_length,
                            json[i].average_read_length,
                            json[i].is_active
                            /*json[i].runs.length,
                            json[i].runs[0].computer_name,
                            json[i].runs[0].minion_name,
                            json[i].runs[0].minKNOW_version,
                            json[i].runs[0].sample_name,*/
                        ]);
                    }
                    return data;
                }
            },
            'columnDefs': [
                {
                    'targets': 0,
                    'data': 0,
                    'render': function(data, type, full, meta) {
                        return '<a href="/web/private/flowcells/' + data + '/"> See details</a>';
                    }
                },
                {
                    'targets': 10,
                    'data': 0,
                    'render': function(data, type, full, meta) {
                        console.log(data);
                        if (data) {
                            return 'Active';
                        } else {
                            return 'Inactive';
                        }
                    }
                },
            ]
        });

    });

    function delete_run(id) {
        $.ajax({
            url: '/api/v1/runs/' + id + '/',
            type: 'GET',
            success: function(data) {

                var csrftoken = Cookies.get('csrftoken');

                $.ajaxSetup({
                    beforeSend: function (xhr, settings) {
                        if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                            xhr.setRequestHeader("X-CSRFToken", csrftoken);
                        }
                    }
                });

                $.ajax({
                    url: '/api/v1/runs/' + id + '/',
                    type: 'PUT',
                    'data': {
                        "run_id": data['run_id'],
                        "run_name": data['run_name'],
                        "to_delete": "True",
                    },
                    success: function(data2) {
                        table_active_runs.ajax.reload();
                        table_all_runs.ajax.reload();
                    }
                });
            },
        });
    }

</script>
{% endblock %}
